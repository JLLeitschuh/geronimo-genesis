<?xml version="1.0" encoding="UTF-8"?>

<!-- $Rev$ $Date$ -->

<project default="bootstrap">
    
    <macrodef name="mvn">
        <attribute name="goal"/>
        <attribute name="dir" default="${basedir}"/>
        <sequential>
            <exec executable="mvn${platform.script.ext}" dir="@{dir}">
                <arg value="@{goal}"/>
            </exec>
        </sequential>
    </macrodef>
    
    <macrodef name="build-stage">
        <attribute name="name"/>
        <sequential>
            <exec executable="mvn${platform.script.ext}" dir="${basedir}">
                <arg value="-Dstage=@{name}"/>
                <arg value="install"/>
            </exec>
        </sequential>
    </macrodef>
    
    <target name="init" depends="init:discover, init:windows, init:defaults">
        <record name="${basedir}/bootstrap.log"/>
        <echo>Starting bootstrap build...</echo>
    </target>
    
    <target name="init:discover">
        <condition property="isWindows">
            <os family="windows"/>
        </condition>
    </target>
    
    <target name="init:windows" if="isWindows">
        <property name="platform.script.ext" value=".bat"/>
    </target>
    
    <target name="init:defaults">
        <property name="platform.script.ext" value=""/>
    </target>
    
    
    <!-- ===== -->
    <!-- Steps -->
    <!-- ===== -->
    
    <target name="bootstrap" depends="clean, stage1, stage2"/>
    
    <target name="stage1" depends="init">
        <build-stage name="bootstrap"/>
    </target>
    
    <target name="stage2" depends="init">
        <mvn goal="install"/>
    </target>
    
    
    <!-- ======== -->
    <!-- Cleaning -->
    <!-- ======== -->
    
    <target name="clean" depends="init">
        <echo>Cleaning...</echo>
        
        <mkdir dir="${user.home}/.m2/repository"/>
        
        <delete>
            <fileset dir="${user.home}/.m2/repository">
                <include name="org/apache/geronimo/genesis/**"/>
            </fileset>
        </delete>
        
        <mvn goal="clean"/>
    </target>

</project>
